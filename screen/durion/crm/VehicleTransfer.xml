<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd" default-menu-title="Transfer Vehicle">

    <parameter name="vehicleId" required="true"/>
    <parameter name="partyId" required="true"/>

    <transition name="transferVehicle">
        <service-call name="durion.positivity.CrmRestServices.transfer#VehicleBetweenCustomers" in-map="context" out-map="transferResult"/>
        <default-response url="../VehicleEdit" parameter-map="[vehicleId: vehicleId, customerId: targetPartyId]"/>
        <error-response url="."/>
    </transition>

    <transition name="cancel">
        <default-response url="../VehicleEdit" parameter-map="[vehicleId: vehicleId, customerId: partyId]"/>
    </transition>

    <transition name="searchCustomers">
        <service-call name="durion.crm.PartyServices.search#Parties" in-map="context" out-map="searchResult"/>
        <default-response url="."/>
    </transition>

    <transition name="selectCustomer">
        <default-response url="."/>
    </transition>

    <actions>
        <script><![CDATA[
            // Get vehicle details
            if (vehicleId) {
                Map vehicleResult = ec.service.sync().name("durion.positivity.VehicleInventoryServices.get#Vehicle").parameters([vehicleId: vehicleId]).call()
                vehicle = vehicleResult.vehicle
            }
            
            // Get source customer details
            if (partyId) {
                Map customerResult = ec.service.sync().name("durion.positivity.CrmRestServices.get#Party").parameters([partyId: partyId]).call()
                sourceCustomer = customerResult
            }
        ]]>        </script>
    </actions>

    <widgets>
        <container>
            <link url="cancel" text="← Back to Vehicle" btn-type="default"/>
            <label text="Transfer Vehicle Ownership" type="h1"/>
        </container>

        <container-box>
            <box-header title="Vehicle Information"/>
            <box-body>
                <label text="VIN: ${vehicle?.vin}" type="p"/>
                <label text="Unit Number: ${vehicle?.unitNumber}" type="p"/>
                <label text="Description: ${vehicle?.description}" type="p"/>
                <label text="Current Owner: ${sourceCustomer?.legalName ?: sourceCustomer?.displayName}" type="p"/>
            </box-body>
        </container-box>

        <container-box>
            <box-header title="Transfer Details"/>
            <box-body>
                <label text="Select the target customer to transfer this vehicle to." type="p"/>

                <form-single name="TransferVehicle" transition="transferVehicle">
                    <field name="vehicleId">
                        <default-field>
                            <hidden default-value="${vehicleId}"/>
                        </default-field>
                    </field>
                    <field name="partyId">
                        <default-field>
                            <hidden default-value="${partyId}"/>
                        </default-field>
                    </field>

                    <field name="targetPartyId">
                        <default-field title="Target Customer *" tooltip="Enter the party ID to transfer to">
                            <text-line size="40" placeholder="Party ID"/>
                    <field name="targetCustomerId">
                        <default-field title="Target Customer *" tooltip="Enter the customer ID to transfer to">
                            <text-line size="40" placeholder="Customer UUID" default-value="${selectedCustomerId}"/>
                        </default-field>
                    </field>

                    <field name="notes">
                        <default-field title="Transfer Notes">
                            <text-area rows="4" cols="60" placeholder="Optional notes about this transfer"/>
                        </default-field>
                    </field>

                    <field name="submitButton">
                        <default-field title="Transfer Vehicle">
                            <submit confirmation="Are you sure you want to transfer this vehicle?"/>
                        </default-field>
                    </field>
                    <field name="cancelButton">
                        <default-field title="">
                            <link url="cancel" text="Cancel" btn-type="default"/>
                        </default-field>
                    </field>
                </form-single>
            </box-body>
        </container-box>

        <container-box>
            <box-header title="Search for Customer"/>
            <box-body>
                <label text="Search for a customer by name, email, phone, tax ID, party type, or status." type="p"/>

                <form-single name="SearchCustomers" transition="searchCustomers">
                    <field name="vehicleId">
                        <default-field>
                            <hidden default-value="${vehicleId}"/>
                        </default-field>
                    </field>
                    <field name="customerId">
                        <default-field>
                            <hidden default-value="${customerId}"/>
                        </default-field>
                    </field>
                    <field name="selectedCustomerId">
                        <default-field>
                            <hidden default-value="${selectedCustomerId}"/>
                        </default-field>
                    </field>

                    <field name="name">
                        <default-field title="Name" tooltip="Search by legal name or display name">
                            <text-line size="40"/>
                        </default-field>
                    </field>

                    <field name="email">
                        <default-field title="Email" tooltip="Search by email address">
                            <text-line size="40"/>
                        </default-field>
                    </field>

                    <field name="phone">
                        <default-field title="Phone" tooltip="Search by phone number">
                            <text-line size="30"/>
                        </default-field>
                    </field>

                    <field name="taxId">
                        <default-field title="Tax ID" tooltip="Search by tax ID or EIN">
                            <text-line size="30"/>
                        </default-field>
                    </field>

                    <field name="partyType">
                        <default-field title="Party Type">
                            <drop-down allow-empty="true">
                                <option key="ORGANIZATION" text="Commercial Account / Organization"/>
                                <option key="INDIVIDUAL" text="Individual Person"/>
                            </drop-down>
                        </default-field>
                    </field>

                    <field name="status">
                        <default-field title="Status">
                            <drop-down allow-empty="true">
                                <option key="ACTIVE" text="Active"/>
                                <option key="PENDING" text="Pending"/>
                                <option key="SUSPENDED" text="Suspended"/>
                                <option key="INACTIVE" text="Inactive"/>
                            </drop-down>
                        </default-field>
                    </field>

                    <field name="pageSize">
                        <default-field title="Results Per Page">
                            <drop-down no-current-selected-key="20">
                                <option key="10" text="10"/>
                                <option key="20" text="20"/>
                                <option key="50" text="50"/>
                                <option key="100" text="100"/>
                            </drop-down>
                        </default-field>
                    </field>

                    <field name="searchButton">
                        <default-field title="Search">
                            <submit/>
                        </default-field>
                    </field>
                </form-single>

                <!-- Search Results Section -->
                <section name="SearchResultsSection">
                    <condition>
                        <expression>showSearchResults</expression>
                    </condition>
                    <widgets>
                        <!-- No Results Message -->
                        <section name="NoResultsSection">
                            <condition>
                                <expression>customerList == null || customerList.isEmpty()</expression>
                            </condition>
                            <widgets>
                                <container style="alert alert-info">
                                    <label text="No customers found matching your search criteria."/>
                                    <label text="Try adjusting your search parameters."/>
                                </container>
                            </widgets>
                        </section>

                        <!-- Results List -->
                        <section name="ResultsListSection">
                            <condition>
                                <expression>customerList != null &amp;&amp; !customerList.isEmpty()</expression>
                            </condition>
                            <widgets>
                                <container>
                                    <label text="Found ${totalCustomers} customers" type="strong"/>
                                </container>

                                <form-list name="CustomerSearchResults" list="customerList" skip-form="true">
                                    <field name="partyId">
                                        <default-field title="Party ID">
                                            <display/>
                                        </default-field>
                                    </field>

                                    <field name="partyType">
                                        <default-field title="Type">
                                            <display/>
                                        </default-field>
                                    </field>

                                    <field name="legalName">
                                        <default-field title="Legal Name">
                                            <display/>
                                        </default-field>
                                    </field>

                                    <field name="displayName">
                                        <default-field title="Display Name">
                                            <display/>
                                        </default-field>
                                    </field>

                                    <field name="status">
                                        <default-field title="Status">
                                            <display/>
                                        </default-field>
                                    </field>

                                    <field name="selectAction">
                                        <default-field title="">
                                            <link url="selectCustomer" text="Select" 
                                                  parameter-map="[vehicleId: vehicleId, customerId: customerId, selectedCustomerId: partyId]" 
                                                  btn-type="success"/>
                                        </default-field>
                                    </field>
                                </form-list>
                            </widgets>
                        </section>

                        <!-- Selected Customer Display -->
                        <section name="SelectedCustomerSection">
                            <condition>
                                <expression>selectedCustomer != null</expression>
                            </condition>
                            <widgets>
                                <container style="alert alert-success">
                                    <label text="Selected Customer:" type="strong"/>
                                    <label text="ID: ${selectedCustomer?.partyId ?: 'N/A'}" type="p"/>
                                    <label text="Name: ${selectedCustomer?.legalName ?: selectedCustomer?.displayName ?: 'N/A'}" type="p"/>
                                    <label text="Type: ${selectedCustomer?.partyType ?: 'N/A'}" type="p"/>
                                    <label text="Status: ${selectedCustomer?.status ?: 'N/A'}" type="p"/>
                                    <label text="The customer ID has been populated in the Transfer Details form above." type="p"/>
                                </container>
                            </widgets>
                        </section>
                    </widgets>
                </section>
            </box-body>
        </container-box>

        <container>
            <label text="Note: This transfer will:" type="strong"/>
            <label text="• Remove the vehicle from the current customer" type="p"/>
            <label text="• Add the vehicle to the target customer" type="p"/>
            <label text="• Update the vehicle's account ID" type="p"/>
            <label text="• Create an audit trail of the transfer" type="p"/>
        </container>
    </widgets>
</screen>

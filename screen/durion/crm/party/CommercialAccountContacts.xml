<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd" default-menu-title="Account Contacts" default-menu-index="3">

    <parameter name="partyId" required="true"/>
    <parameter name="correlationId"/>

    <transition name="addContact">
        <service-call name="durion.crm.PartyServices.create#PartyRelationship"/>
        <default-response url=".">
            <parameter name="partyId"/>
        </default-response>
    </transition>

    <transition name="setPrimaryBilling">
        <service-call name="durion.crm.PartyServices.setPrimaryBilling#Contact"/>
        <default-response url=".">
            <parameter name="partyId"/>
        </default-response>
    </transition>

    <transition name="deactivateContact">
        <service-call name="durion.crm.PartyServices.deactivate#PartyRelationship"/>
        <default-response url=".">
            <parameter name="partyId"/>
        </default-response>
    </transition>

    <transition name="PartyDetail">
        <default-response url="../PartyDetail"/>
    </transition>

    <transition name="PersonCreate">
        <default-response url="../PersonCreate"/>
    </transition>

    <transition name="PartyFind">
        <default-response url="../PartyFind"/>
    </transition>

    <transition name="editRoles">
        <default-response url="./ContactRolesEdit">
            <parameter name="partyId"/>
            <parameter name="contactId"/>
            <parameter name="returnUrl" from="ec.web.getScreenUrl('.', null, false)"/>
        </default-response>
    </transition>

    <actions>
        <!-- Get account details -->
        <service-call name="durion.crm.PartyServices.get#Party" in-map="[partyId: partyId]" out-map="partyResult"/>
        <set field="account" from="partyResult.party"/>

        <!-- Load contacts with roles -->
        <service-call name="durion.crm.PartyServices.get#ContactsWithRoles" in-map="[partyId: partyId]" out-map="contactsResult"/>
        <set field="contacts" from="contactsResult.contacts ?: []"/>
        <set field="invoiceDeliveryMethod" from="contactsResult.invoiceDeliveryMethod"/>

        <!-- Check permissions -->
        <set field="canView" from="ec.user.hasPermission('crm:contact:view')"/>
        <set field="canViewRoles" from="ec.user.hasPermission('crm:contact_role:view')"/>
        <set field="canEdit" from="ec.user.hasPermission('crm:party:edit')"/>
        <set field="canEditRoles" from="ec.user.hasPermission('crm:contact_role:assign')"/>
    </actions>

    <widgets>
        <container-box>
            <box-header title="Commercial Account Contacts"/>
            <box-toolbar>
                <link url="PartyDetail" text="Back to Account">
                    <parameter name="partyId"/>
                </link>
            </box-toolbar>
            <box-body>

                <!-- Permission Denied -->
                <section name="PermissionDeniedSection" condition="!canView">
                    <widgets>
                        <container style="alert alert-danger">
                            <label text="Access Denied" type="h5"/>
                            <label text="You do not have permission to view account contacts. Required permission: crm:contact:view"/>
                        </container>
                    </widgets>
                </section>

                <!-- Error State -->
                <section name="ErrorSection" condition="ec.message.hasError()">
                    <widgets>
                        <container style="alert alert-danger">
                            <label text="Error" type="h5"/>
                            <render-mode>
                                <text type="html" location="component://webroot/screen/webroot/MessageText.html.ftl"/>
                            </render-mode>
                            <section name="CorrelationIdSection" condition="correlationId">
                                <widgets>
                                    <label text="Correlation ID: ${correlationId}" style="text-muted small"/>
                                </widgets>
                            </section>
                        </container>
                    </widgets>
                </section>

                <!-- Success Messages -->
                <section name="SuccessSection" condition="ec.message.messages">
                    <widgets>
                        <container style="alert alert-success">
                            <render-mode>
                                <text type="html" location="component://webroot/screen/webroot/MessageText.html.ftl"/>
                            </render-mode>
                        </container>
                    </widgets>
                </section>

                <section name="MainSection" condition="canView">
                    <widgets>

                        <!-- Account Summary -->
                        <section name="AccountSummary" condition="account">
                            <widgets>
                                <container style="mb-4">
                                    <label text="Account: ${account.legalName}" type="h6"/>
                                    <label text="Party ID: ${partyId}" style="text-muted small"/>
                                    <section name="InvoiceDeliverySection" condition="invoiceDeliveryMethod">
                                        <widgets>
                                            <label text="Invoice Delivery: ${invoiceDeliveryMethod}" style="text-muted small ml-3"/>
                                        </widgets>
                                    </section>
                                </container>
                            </widgets>
                        </section>

                        <!-- Add Contact Form -->
                        <section name="AddContactSection" condition="canEdit">
                            <widgets>
                                <container-box>
                                    <box-header title="Add Contact to Account"/>
                                    <box-body>
                                        <form-single name="AddContactForm" transition="addContact">
                                            <field name="partyId">
                                                <default-field>
                                                    <hidden/>
                                                </default-field>
                                            </field>

                                            <field name="toPartyId">
                                                <default-field title="Person*">
                                                    <text-line size="50"/>
                                                    <label text="Enter Person Party ID or use search" style="form-text text-muted small"/>
                                                </default-field>
                                            </field>

                                            <field name="relationshipTypeCode">
                                                <default-field title="Role*">
                                                    <drop-down>
                                                        <option key="APPROVER" text="Approver - Can approve estimates"/>
                                                        <option key="BILLING" text="Billing Contact - Receives invoices"/>
                                                    </drop-down>
                                                </default-field>
                                            </field>

                                            <field name="isPrimaryBilling">
                                                <conditional-field condition="relationshipTypeCode == 'BILLING'" title="">
                                                    <check>
                                                        <option key="true" text="Set as Primary Billing Contact"/>
                                                    </check>
                                                    <label text="(Only one primary billing contact allowed per account)" style="form-text text-muted small"/>
                                                </conditional-field>
                                                <default-field>
                                                    <ignored/>
                                                </default-field>
                                            </field>

                                            <field name="submitButton">
                                                <default-field title="">
                                                    <submit text="Add Contact"/>
                                                </default-field>
                                            </field>
                                        </form-single>

                                        <container style="mt-3">
                                            <label text="Don't have a Person ID?" style="text-muted"/>
                                            <link url="PersonCreate" text="Create New Person" link-type="anchor"/>
                                            <label text=" or " style="mx-2"/>
                                            <link url="PartyFind" text="Search for Existing Person" link-type="anchor">
                                                <parameter name="partyType" value="PERSON"/>
                                            </link>
                                        </container>
                                    </box-body>
                                </container-box>
                            </widgets>
                        </section>

                        <!-- Existing Contacts List -->
                        <container-box>
                            <box-header title="Existing Contacts"/>
                            <box-body>

                                <section name="NoContacts" condition="contacts.isEmpty()">
                                    <widgets>
                                        <container style="alert alert-info">
                                            <label text="No contacts associated with this account yet."/>
                                        </container>
                                    </widgets>
                                </section>

                                <section name="ContactsList" condition="!contacts.isEmpty()">
                                    <widgets>
                                        <form-list name="ContactsList" list="contacts" skip-form="true">

                                            <field name="contactName">
                                                <default-field title="Contact Name">
                                                    <link url="PartyDetail" text="${contactName}" link-type="anchor">
                                                        <parameter name="partyId" from="contactId"/>
                                                    </link>
                                                </default-field>
                                            </field>

                                            <field name="email">
                                                <default-field title="Email">
                                                    <display text="${email ?: '-'}"/>
                                                </default-field>
                                            </field>

                                            <field name="phone">
                                                <default-field title="Phone">
                                                    <display text="${phone ?: '-'}"/>
                                                </default-field>
                                            </field>

                                            <field name="hasPrimaryEmail">
                                                <default-field title="Primary Email">
                                                    <display text="${hasPrimaryEmail ? 'Yes' : 'No'}"/>
                                                </default-field>
                                            </field>

                                            <field name="rolesDisplay">
                                                <conditional-field condition="canViewRoles">
                                                    <default-field title="Roles">
                                                        <render-mode>
                                                            <text type="html"><![CDATA[
                                                                <#assign rolesList = roles ?: []>
                                                                <#if rolesList?has_content>
                                                                    <#list rolesList as role>
                                                                        <span class="badge badge-secondary mr-1">
                                                                            ${role.roleCode}<#if role.isPrimary> (Primary)</#if>
                                                                        </span>
                                                                    </#list>
                                                                <#else>
                                                                    <span class="text-muted">No roles assigned</span>
                                                                </#if>
                                                            ]]></text>
                                                        </render-mode>
                                                    </default-field>
                                                </conditional-field>
                                                <default-field title="Roles">
                                                    <display text="(Permission required)"/>
                                                </default-field>
                                            </field>

                                            <!-- Actions -->
                                            <field name="actions">
                                                <conditional-field condition="canEditRoles">
                                                    <container>
                                                        <link url="editRoles" text="Edit Roles" link-type="anchor">
                                                            <parameter name="partyId"/>
                                                            <parameter name="contactId"/>
                                                        </link>
                                                    </container>
                                                </conditional-field>
                                                <conditional-field condition="!canEditRoles &amp;&amp; canViewRoles">
                                                    <display text="View Only"/>
                                                </conditional-field>
                                                <default-field>
                                                    <display text=""/>
                                                </default-field>
                                            </field>

                                        </form-list>
                                    </widgets>
                                </section>

                            </box-body>
                        </container-box>

                        <!-- Business Rules Info Panel -->
                        <container-box>
                            <box-header title="Contact Role Business Rules"/>
                            <box-body>
                                <container style="alert alert-info">
                                    <label text="Contact Role Rules:" type="strong"/>
                                    <ul>
                                        <li>
                                            <label text="BILLING: Person who receives invoices and billing communications"/>
                                        </li>
                                        <li>
                                            <label text="APPROVER: Person authorized to approve work order estimates"/>
                                        </li>
                                        <li>
                                            <label text="DRIVER: Vehicle operator for dispatch and delivery"/>
                                        </li>
                                        <li>
                                            <label text="Each contact can have multiple roles assigned"/>
                                        </li>
                                        <li>
                                            <label text="For each role, only one contact can be marked as PRIMARY per account"/>
                                        </li>
                                        <li>
                                            <label text="Setting a new primary for a role automatically demotes the previous primary"/>
                                        </li>
                                        <li>
                                            <label text="When invoice delivery method is EMAIL, at least one billing contact with a primary email is required"/>
                                        </li>
                                        <li>
                                            <label text="Permissions required: crm:contact_role:view (view roles), crm:contact_role:assign (edit roles)"/>
                                        </li>
                                    </ul>
                                </container>
                            </box-body>
                        </container-box>

                    </widgets>
                </section>

            </box-body>
        </container-box>
    </widgets>
</screen>

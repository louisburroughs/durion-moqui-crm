<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd" default-menu-title="Find Vehicles" default-menu-index="3">

    <parameter name="query"/>
    <parameter name="pageIndex" type="Integer" default-value="0"/>
    <parameter name="pageSize" type="Integer" default-value="25"/>

    <transition name="vehicleDetail">
        <default-response url="VehicleEdit"/>
    </transition>

    <transition name="createVehicle">
        <default-response url="VehicleCreate"/>
    </transition>

    <transition name="vehicleSearch">
        <service-call name="durion.positivity.VehicleInventoryServices.search#Vehicles" out-map="searchResult"/>
        <default-response url="."/>
    </transition>

    <actions>
        <script><![CDATA[
            // Only perform search if query is provided
            if (query) {
                // Call vehicle search service from pos-vehicle-inventory
                Map searchParams = [
                    query: query,
                    limit: pageSize,
                    offset: pageIndex * pageSize
                ]
                Map searchResult = ec.service.sync().name("durion.positivity.VehicleInventoryServices.search#Vehicles").parameters(searchParams).call()
                vehicles = searchResult.results ?: []
                totalCount = searchResult.total ?: 0
                
                // Calculate pagination values
                totalPages = (int) Math.ceil((double) totalCount / pageSize)
                currentPage = pageIndex + 1 // Display 1-based page numbers
                hasNextPage = pageIndex < (totalPages - 1)
                hasPrevPage = pageIndex > 0
            } else {
                vehicles = []
                totalCount = 0
                totalPages = 0
                currentPage = 0
                hasNextPage = false
                hasPrevPage = false
            }
        ]]>        </script>
    </actions>

    <widgets>
        <container>
            <label text="Vehicle Lookup" type="h1"/>
            <label text="Search by VIN, Unit #, or Plate"/>
        </container>

        <form-single name="VehicleSearch" transition="vehicleSearch">
            <field name="query">
                <default-field title="Search">
                    <text-line size="40" placeholder="VIN, Unit #, or License Plate"/>
                </default-field>
            </field>
            <field name="pageIndex">
                <default-field>
                    <hidden default-value="0"/>
                </default-field>
            </field>
            <field name="pageSize">
                <default-field>
                    <hidden default-value="${pageSize}"/>
                </default-field>
            </field>
            <field name="submitButton">
                <default-field title="Search">
                    <submit/>
                </default-field>
            </field>
        </form-single>

        <container-box>
            <box-header title="Search Results"/>
            <box-body>
                <label text="No vehicles found. Try a different search." condition="query &amp;&amp; !vehicles" type="p"/>
                <label text="Enter a search query above to find vehicles." condition="!query" type="p"/>

                <form-list name="VehicleList" list="vehicles" skip-form="true" skip-start="true" skip-end="true">
                    <field name="vehicleId">
                        <default-field title="Vehicle ID">
                            <link url="vehicleDetail" text="${vehicleId}" parameter-map="[vehicleId: vehicleId]"/>
                        </default-field>
                    </field>
                    <field name="vin">
                        <default-field title="VIN">
                            <display/>
                        </default-field>
                    </field>
                    <field name="unitNumber">
                        <default-field title="Unit #">
                            <display/>
                        </default-field>
                    </field>
                    <field name="licensePlate">
                        <default-field title="Plate">
                            <display/>
                        </default-field>
                    </field>
                    <field name="year">
                        <default-field>
                            <display/>
                        </default-field>
                    </field>
                    <field name="make">
                        <default-field>
                            <display/>
                        </default-field>
                    </field>
                    <field name="model">
                        <default-field>
                            <display/>
                        </default-field>
                    </field>
                    <field name="description">
                        <default-field>
                            <display/>
                        </default-field>
                    </field>
                </form-list>

                <label text="Found ${totalCount} vehicle(s)" condition="totalCount > 0" type="p"/>
                
                <!-- Pagination Controls -->
                <container condition="totalPages > 1" style="text-align: center; margin-top: 15px;">
                    <link url="." text="← Previous" 
                          parameter-map="[query: query, pageIndex: pageIndex - 1, pageSize: pageSize]" 
                          condition="hasPrevPage" 
                          btn-type="default"/>
                    <label text="Page ${currentPage} of ${totalPages}" style="display: inline-block; margin: 0 15px;"/>
                    <link url="." text="Next →" 
                          parameter-map="[query: query, pageIndex: pageIndex + 1, pageSize: pageSize]" 
                          condition="hasNextPage" 
                          btn-type="default"/>
                </container>
            </box-body>
            <box-toolbar>
                <link url="createVehicle" text="Create New Vehicle" btn-type="primary"/>
            </box-toolbar>
        </container-box>
    </widgets>
</screen>
